<cfsetting requesttimeout="10000">

<!-- update passwords -->
<cfadmin
    action="hasPassword"
    type="server"
    returnVariable="hasPassword">

<cfif NOT hasPassword>
	<!-- only do this if it hasn't been set up yet -->
	<cftry>
		<cfadmin 
			action="updatePassword"
			type="server"
			newPassword="<%= node['railo']['server_password'] %>">
		<cfcatch><cfdump var="#cfcatch#"></cfcatch>
	</cftry>
	<cftry>
		<cfadmin 
			action="updateDefaultPassword"
			type="server"
			password="<%= node['railo']['server_password'] %>"
			newPassword="<%= node['railo']['web_password'] %>">
		<cfcatch><cfdump var="#cfcatch#"></cfcatch>
	</cftry>
</cfif>

<!-- add in some datasources -->
<% node['railo']['datasources'].each do |dsnname, conf| %>
	<cftry>
		<cfadmin 
			action="updateDatasource"
			type="server"
			password="<%= node['railo']['server_password'] %>"

			dbusername="<%= conf.username %>"
			dbpassword="<%= conf.password %>"
			name="<%= dsnname %>"
			newName="<%= dsnname %>"
			host="<%= conf.host %>"
			database="<%= conf.database %>"

			classname="org.gjt.mm.mysql.Driver"
			dsn="jdbc:mysql://{host}:{port}/{database}"
			port="3306"

			connectionLimit="-1"
			connectionTimeout="1"
			blob="true"
			clob="true"
			allowed_select="true"
			allowed_insert="true"
			allowed_update="true"
			allowed_delete="true"
			allowed_alter="true"
			allowed_drop="true"
			allowed_revoke="true"
			allowed_create="true"
			allowed_grant="true"
			custom="useUnicode=true&amp;characterEncoding=UTF-8&amp;zeroDateTimeBehavior=convertToNull&amp;tinyInt1isBit=false&amp;autoReconnect=true&amp;jdbcCompliantTruncation=false&amp;allowMultiQueries=false&amp;useOldAliasMetadataBehavior=true&amp;useLegacyDatetimeCode=true" 
			remoteClients="arrayOfClients">
		<cfcatch><cfdump var="#cfcatch#"></cfcatch>
	</cftry>
<% end %>


<cftry>
	<cfadmin 
		action="getRemoteClients"
		type="server"
		password="<%= node['railo']['server_password'] %>"
		returnVariable="arrRemoteClients">


	<!-- Locale settings -->
	<cftry>
		<cfadmin
			action="updateRegional"
			type="server"
			password="<%= node['railo']['server_password'] %>"
			timezone="Europe/London"
			locale="en_GB"
			timeserver="pool.ntp.org"
			remoteClients="#arrRemoteClients#">
		<cfcatch><cfdump var="#cfcatch#"></cfcatch>
	</cftry>

	<!-- Output settings -->
	<cftry>
		<cfadmin
			action="updateOutputSetting"
			type="server"
			password="<%= node['railo']['server_password'] %>"
			supressWhiteSpace="white-space-pref"
			showVersion="false"
			remoteClients="#arrRemoteClients#">
		<cfcatch><cfdump var="#cfcatch#"></cfcatch>
	</cftry>
		
	<!-- update update settings -->
	<cftry>
		<cfadmin 
			action="UpdateUpdate"
			type="server"
			password="<%= node['railo']['server_password'] %>"
			
			updateType="auto"
			updateLocation="http://www.getrailo.org"
			remoteClients="#arrRemoteClients#">
		<cfcatch><cfdump var="#cfcatch#"></cfcatch>
	</cftry>

	<!-- run an update -->
	<cftry>
		<cfadmin 
			action="runUpdate"
			type="server"
			password="<%= node['railo']['server_password'] %>"
			remoteClients="#arrRemoteClients#">
		<cfcatch><cfdump var="#cfcatch#"></cfcatch>
	</cftry>
	<cfcatch><cfdump var="#cfcatch#"></cfcatch>
</cftry>




